<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Editor de Flujos</title>

    <!-- CSS global -->
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/components.css" />
</head>

<body>

    <!-- PANEL IZQUIERDO -->
    <div id="leftPanel">
        <div class="left-panel-accordion">
            <details class="left-panel-section">
                <summary><h2>Ficha del procedimiento</h2></summary>
                <div class="left-panel-section-body">
                    <button class="btn" id="btnFichaProyecto">Ficha del procedimiento</button>
                    <button class="btn" id="btnVerCSV">üìã Ver procedimiento</button>
                    <button class="btn" id="btnExportDocx">üìÑ Exportar resumen DOCX</button>
                </div>
            </details>

            <details class="left-panel-section">
                <summary><h2>Nodos</h2></summary>
                <div class="left-panel-section-body">
                    <button class="btn" onclick="Engine.createNode('formulario')">+ Formulario</button>
                    <button class="btn" onclick="Engine.createNode('documento')">+ Documento</button>
                    <button class="btn" onclick="Engine.createNode('libre')">+ Libre</button>
                    <button class="btn" onclick="Engine.createNode('decision')">+ Decisi√≥n</button>
                    <button class="btn" onclick="Engine.createNode('circuito')">+ Circuito Resoluci√≥n</button>
                    <button class="btn" onclick="Engine.createNode('plazo')">+ A√±adir Plazo</button>
                    <button class="btn" onclick="Engine.createNode('operacion_externa')">+ Operaci√≥n Externa</button>
                    <button class="btn" onclick="Engine.createNode('notas')">+ Nota</button>
                </div>
            </details>

            <details class="left-panel-section">
                <summary><h2>Guardar</h2></summary>
                <div class="left-panel-section-body">
                    <button class="btn" id="btnSaveJSONDb">üóÑÔ∏è Guardar en BDD</button>
                    <button class="btn" id="btnExportJSON" onclick="Engine.exportToJSON()">üíæ Descargar Json</button>
                </div>
            </details>

            <details class="left-panel-section">
                <summary><h2>Cargar</h2></summary>
                <div class="left-panel-section-body">
                    <input type="file" id="fileLoader" accept=".json" style="display:none" onchange="loadJSONFile(event)">
                    <button class="btn" id="btnImportJSON" onclick="document.getElementById('fileLoader').click()">üìÇ Cargar Json</button>
                    <button class="btn" id="btnLoadJSONDb">üóÑÔ∏è Cargar de BDD</button>
                    <div class="json-buttons-row">
                        <button id="btnPasteJSON">üìã Pegar JSON</button>
                        <button id="btnIAJson" title="Abrir asistente IA JSON">
                            ü§ñ IA JSON
                        </button>
                    </div>
                </div>
            </details>

            <details class="left-panel-section">
                <summary><h2>Exportar CSV</h2></summary>
                <div class="left-panel-section-body">
                    <button class="btn" id="btnExportFlujo" onclick="Engine.exportFlujoCSV()">üì§ Exportar CSV proceso</button>
                    <button class="btn" id="btnExportTesauro">üì§ Exportar CSV tesauros</button>
                </div>
            </details>
        </div>

        <script>
        function loadJSONFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                Engine.importFromJSON(evt.target.result);
            };
            reader.readAsText(file);
        }
        </script>

        <!-- Bot√≥n de importaci√≥n -->
        <!--<button id="btnImportFlujo" class="btn">üì• Importar Flujo CSV</button>-->
        <!-- Bot√≥n ver copypaste -->

        <div id="importFromTextBlock" style="margin-top:20px; padding:10px; border-top:1px solid #ccc;">
            <button id="btnImportarTexto"
                class="btn"
                style="width:100%; background:#2563eb; color:white;">
                Importar diagrama desde Gestiona
            </button>
        </div>
        <!-- Input oculto para seleccionar los dos archivos -->
        <input
            type="file"
            id="inputFlujoCSV"
            accept=".csv"
            multiple
            style="display: none;">
    </div>

    <!-- ZONA DE DIBUJO -->
    <div id="canvasArea">
            <svg id="svgConnections"></svg>
            <div id="nodesContainer"></div>
    </div>
    <div id="projectTitle">

    </div>
    
    <!-- üîò Bot√≥n flotante -->
    <button id="btnAsignaciones" class="floating-assign-btn">üìã Asignaciones</button>
    <button id="btnCambiosEstado" class="floating-cambios-btn">üîÑ Cambios de estado</button>

    <!-- Barra flotante del wizard -->
    <div id="floatingControlGroup" class="floating-control-group">
        <button id="btnWizard" class="floating-wizard-btn">üßô Asistente</button>
    </div>
        <!-- Panel derecho-->
    <div id="rightPanel">
        <h3>Propiedades</h3>
        <div id="propsEmpty">Selecciona un nodo.</div>
    
        <div id="propsEditor" style="display:none;">
            <label>T√≠tulo</label>
            <input id="propTitulo" />
            <label>Tipo de nodo</label>
            <select id="propTipo">
                <option value="formulario">Formulario</option>
                <option value="documento">Documento</option>
                <option value="libre">Libre</option>
                <option value="decision">Decisi√≥n</option>
                <option value="circuito">Circuito Resoluci√≥n</option>
                <option value="plazo">A√±adir Plazo</option>
                <option value="operacion_externa">Operaci√≥n Externa</option>
                <option value="notas">Nota</option>
            </select>
            <label>Descripci√≥n</label>
            <div id="propToolbar" class="prop-toolbar">
                <button data-cmd="bold" title="Negrita"><svg width="14" height="14" viewBox="0 0 24 24"><path d="M7 5h7a3 3 0 010 6H7zm0 6h8a3 3 0 010 6H7z" fill="currentColor"/></svg></button>
                <button data-cmd="italic" title="Cursiva"><svg width="14" height="14" viewBox="0 0 24 24"><path d="M10 5v2h2.58l-3.16 10H7v2h7v-2h-2.58l3.16-10H17V5z" fill="currentColor"/></svg></button>
                <button data-cmd="underline" title="Subrayado"><svg width="14" height="14" viewBox="0 0 24 24"><path d="M12 17a5 5 0 005-5V5h-2v7a3 3 0 01-6 0V5H7v7a5 5 0 005 5zM5 19h14v2H5z" fill="currentColor"/></svg></button>
                <span class="separator"></span>
                <button data-cmd="justifyLeft" title="Izquierda"><svg width="14" height="14" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 4h12v2H3zm0 4h18v2H3zm0 4h12v2H3z" fill="currentColor"/></svg></button>
                <button data-cmd="justifyCenter" title="Centro"><svg width="14" height="14" viewBox="0 0 24 24"><path d="M4 6h16v2H4zm2 4h12v2H6zm-2 4h16v2H4zm2 4h12v2H6z" fill="currentColor"/></svg></button>
                <button data-cmd="justifyRight" title="Derecha"><svg width="14" height="14" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm6 4h12v2H9zm-6 4h18v2H3zm6 4h12v2H9z" fill="currentColor"/></svg></button>
            </div>
            
            <div id="propDescripcion" contenteditable="true" class="prop-wysi"></div>
            <label style="margin-top:10px;">Tarea manual</label>
            <input type="checkbox" id="propTareaManual">

            <h4>Salidas</h4>
            <div id="salidasList"></div>
    
            <!-- üóëÔ∏è Nuevo bot√≥n -->
            <button id="btnDeleteNode" class="btn" style="background:#dc2626; color:white; margin-top:15px;">
                üóëÔ∏è Eliminar nodo
            </button>
          
        </div>
        <div style="margin-top:10px;">
            <button id="btnUndo" class="btn" style="background:#6b7280; color:white;">‚Ü©Ô∏è Deshacer</button>
            <button id="btnRedo" class="btn" style="background:#6b7280; color:white;">‚Ü™Ô∏è Rehacer</button>
        </div>
                    

    </div>
    <div id="fichaProyecto" class="ficha-panel hidden">
        <h2>Ficha del proyecto</h2>
    
        <label>Procedimiento</label>
        <input type="text" id="fpProcedimiento">
    
        <label>Actividad</label>
        <input type="text" id="fpActividad">
    
        <label>Descripci√≥n del procedimiento</label>
        <textarea id="fpDescripcion"></textarea>
    
        <button id="fpGuardar" class="btn">Guardar</button>
        <button id="fpCerrar" class="btn btn-secundario">Cerrar</button>
    </div>
    <!-- =========================
        POPUP PREVISUALIZAR CSV
    ========================= -->
<div id="csvModal" class="modal hidden">
    <div class="modal-content">

        <!-- üîπ CABECERA -->
        <div class="csv-modal-header">
            <h2>Vista previa del flujo (CSV)</h2>
            <button id="csvCerrar" class="csv-close-btn" aria-label="Cerrar">&times;</button>
        </div>

        <!-- üîπ CONTENIDO -->
        <div id="csvContent" class="csv-content"></div>

    </div>
</div>   

<!-- =========================
    MODAL IMPORTAR DIAGRAMA DESDE GESTIONA
========================= -->
<div id="importTextModal" class="modal hidden">
    <div class="modal-content modal-content--wide">
        <div class="csv-modal-header import-text-header">
            <h2>Importar diagrama desde Gestiona</h2>
            <div class="import-text-actions">
                <button id="btnValidarImportText" class="btn btn-import-validate" disabled>VALIDAR</button>
                <button id="importTextClose" class="csv-close-btn" aria-label="Cerrar">&times;</button>
            </div>
        </div>
        <div class="import-text-body">
            <label for="importTextTextarea">Pega aqu√≠ la definici√≥n del flujo desde Gestiona</label>
            <textarea id="importTextTextarea" placeholder="Pega aqu√≠ la definici√≥n de tareas‚Ä¶"></textarea>
            <button id="importTextLoad" class="btn btn-import-load">Cargar</button>
            <div id="importTextSummary" class="csv-content import-text-summary"></div>
        </div>
    </div>
</div>

<!-- =========================
    MODAL GUARDAR / CARGAR JSON DESDE BDD
========================= -->
<div id="flowDbModal" class="modal hidden">
    <div class="modal-content modal-content--wide flow-db-modal">
        <div class="csv-modal-header flow-db-header">
            <div class="flow-db-title">
                <h2 id="flowDbTitle">Guardar JSON en base de datos</h2>
                <p id="flowDbSubtitle">Organiza los flujos por subfunci√≥n.</p>
            </div>
            <button id="flowDbClose" class="csv-close-btn" aria-label="Cerrar">&times;</button>
        </div>
        <div class="flow-db-body">
            <aside class="flow-db-sidebar">
                <div class="flow-db-sidebar-header">
                    <h3>Subfunciones</h3>
                    <button id="flowDbNewSubfuncion" class="btn btn-flowdb">Crear subfunci√≥n</button>
                </div>
                <div id="flowDbFolders" class="flow-db-folders"></div>
            </aside>
            <section class="flow-db-content">
                <div class="flow-db-content-header">
                    <div class="flow-db-field">
                        <label for="flowDbSubfuncionInput">Subfunci√≥n seleccionada</label>
                        <input id="flowDbSubfuncionInput" type="text" placeholder="Nombre de subfunci√≥n">
                    </div>
                    <div class="flow-db-field" id="flowDbNameField">
                        <label for="flowDbNameInput">Nombre del flujo</label>
                        <input id="flowDbNameInput" type="text" placeholder="Nombre del flujo">
                    </div>
                </div>
                <div id="flowDbList" class="flow-db-list"></div>
                <div class="flow-db-actions">
                    <button id="flowDbPrimaryAction" class="btn btn-flowdb">Guardar</button>
                </div>
            </section>
        </div>
    </div>
</div>

<!-- ============================================================
     LISTAS AUTOCOMPLETAR (Grupos / Usuarios)
============================================================ -->
<datalist id="dlGrupos"></datalist>
<datalist id="dlUsuarios"></datalist>


<!-- =========================
    SCRIPTS (ORDEN CORRECTO)
========================= -->
 <!-- 1Ô∏è‚É£ Librer√≠as externas  -->
 <script src="js/vendor/html2canvas.min.js"></script>
 <!--
 ‚úÖ DOCX versi√≥n estable, expone window.docx correctamente -->
 <script src="js/vendor/docx-8.2.2.umd.js"></script>



<!-- 2Ô∏è‚É£ N√∫cleo y m√≥dulos de la app -->
<script src="js/core/engine.core.js"></script>
<script src="js/core/engine.extensions.js"></script>
<script src="js/core/renderer.js"></script>
<script src="js/features/importtext.js"></script>
<script src="js/interactions/interactions.js"></script>
<script src="js/ui/ui.js"></script>
<script src="js/features/guia.js"></script>

<script src="js/features/asignaciones.js"></script>
<script src="js/features/cambiosestado.js"></script>
<script src="js/features/datatesauro.js"></script>
<script src="js/features/tesauromanager.js"></script>
<script src="js/features/wizard.js"></script>
<script src="js/interactions/resizepanels.js"></script>
<script src="js/features/assistant.js"></script>
<script>
  // üß† Bot√≥n para abrir el GPT personalizado
  document.getElementById("btnIAJson").addEventListener("click", () => {
    window.open(
      "https://chatgpt.com/g/g-6918f6f366d081918def86bc27f3c2b4-gestiona-flow-process",
      "_blank"
    );
  });
</script>

<!-- 3Ô∏è‚É£ Comprobaci√≥n -->
<script>
window.addEventListener("load", () => {
    console.log("üì¶ html2canvas:", typeof html2canvas);
    console.log("üìÑ docx:", window.docx ? "‚úÖ Cargado correctamente" : "‚ùå undefined");
});
</script>
<script>
/* ============================================================
   PEGAR JSON MANUALMENTE DESDE EL PORTAPAPELES
============================================================ */
document.getElementById("btnPasteJSON").addEventListener("click", async () => {
  try {
    // Intentar leer desde el portapapeles si est√° permitido
    let jsonText = "";
    try {
      jsonText = await navigator.clipboard.readText();
    } catch {
      // Si el navegador no permite acceso directo, usar prompt
      jsonText = prompt("Pega aqu√≠ el JSON del diagrama:");
    }

    if (!jsonText) {
      alert("No se ha pegado ning√∫n texto JSON.");
      return;
    }

    // Validar formato b√°sico
    let parsed;
    try {
      parsed = JSON.parse(jsonText);
    } catch (e) {
      alert("‚ùå El texto no es un JSON v√°lido.");
      return;
    }

    // Confirmar con el usuario
    const ok = confirm("¬øQuieres reemplazar el diagrama actual con el JSON pegado?");
    if (!ok) return;

    // Reutilizar la funci√≥n existente de importaci√≥n
    Engine.importFromJSON(jsonText);
    alert("‚úÖ JSON pegado y cargado correctamente.");
  } catch (err) {
    console.error("Error al pegar JSON:", err);
    alert("‚ùå No se pudo procesar el JSON. Revisa la consola.");
  }
});
</script>
</body>
</html>
